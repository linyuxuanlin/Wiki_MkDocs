# ููุงุญุธุงุช ุชุทููุฑ ููุชุจุฉ HAL - ุงูุงุชุตุงู ุจู CAN ๐ง

ูุณุชูุฏ ูุฐุง ุงูููุงู ุฅูู ูุฌููุนุฉ ุชุทููุฑ RobotCtrl ุงูุฎุงุตุฉ ุจูุงุ ููุณุชุฎุฏู ููุงุฉ ุงููููุฑูููุชุฑููุฑ STM32F407ZET6ุ ููุณุชุฎุฏู ุฑูุงูุฉ TJA1050 ููุงุชุตุงู ุจู CAN. ูุฑุฌู ุงูุฑุฌูุน ุฅูู ุงููุฎุทุท ุงูุฃุณุงุณู ูุงูุดุฑุญ ุงูููุตู ูู [**RobotCtrl - STM32 ้็จๅผๅๅฅไปถ**](https://wiki-power.com/ar/RobotCtrl-STM32%E9%80%9A%E7%94%A8%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6) ููุฒูุฏ ูู ุงููุนูููุงุช.

## ุฎุทูุงุช ุจุณูุทุฉ ูุงุฎุชุจุงุฑ ุงูุญููุฉ ุงูุฑุงุฌุนุฉ

### ุงูุชูููู ุงูุฏุงุฎูู ูู CubeMX

1. ุงุณุชูุงุฏูุง ุฅูู ุงูุฃุฌูุฒุฉ ุงููุณุชุฎุฏูุฉ ูู CAN ุ ุงููุฑ ููู ุตูุญุฉ `CAN1` ุฃู `CAN2` ูู ุงูุดุฑูุท ุงูุฌุงูุจู ุงูุฃูุณุฑ ุ ูุญุฏุฏ `Activated` ุ ููู ุตูุญุฉ ุงููุนููุงุช ุ ูู ุจุชูููู ูุฐู ุงููุนููุงุช:
   1. ูู ุจุชุนููู `Prescaler (for Time Quantum)` ุฅูู `6` ุ ููู ุจุชุนููู `Time Quanta in Bit Segment 1` ู `Time Quanta in Bit Segment 2` ุฅูู `3 Times` ุ ููุฐุง ุงูุชุฑููุจ ูุนูุฏ ูุนุฏู ุงูุจุช ุฅูู 1 ููุฌุงุจุช ูู ุงูุซุงููุฉ (ุงูุฃุนูู).
   2. ูู ุจุชูููู `ReSynchronization Jump Width` ุฅูู `1 Time` ุ ููุฐุง ูู ุงูุญุฏ ุงูุฃูุตู ุงูุฐู ูููู ุชุนุฏููู ุนูุฏ ุฅุนุงุฏุฉ ุงููุฒุงููุฉ.
   3. ูู ุจุชูููู `Operating Mode` ุฅูู `Loopback` ุ ููู ูุง ูุณุชุฎุฏู ููุงุฎุชุจุงุฑ ุงูุฏุงุฆุฑู.
2. ูู ุนูุงูุฉ ุงูุชุจููุจ `NVIC Settings` ุ ูู ุจุชูููู `CANx RX0 interrupts`.

### ุงูุชูููู ุงูุฏุงุฎูู ูู ุงูููุฏ

ุฃูุดุฆ `can.c` ูู ุงููุดุฑูุน ุ ููู ุจุชูููู ุงููุตููุงุช ุ ูููุง ุชู ุชูููู ูุถุน ุงููุงุฆูุฉ ุ ูุชู ุชุตููุฉ ูุนุฑู ุงูุชูุณุนุฉ `0x2233` ููุนุฑู ุงูููุงุณู `0`:

```c title="can.c"/*
 * ๅฝๆฐๅ๏ผCAN_Filter_Config
 * ๆ่ฟฐ  ๏ผCAN็่ฟๆปคๅจ ้็ฝฎ
 * ่พๅฅ  ๏ผๆ
 * ่พๅบ  : ๆ
 * ่ฐ็จ  ๏ผๅ้จ่ฐ็จ
 */
static void CAN_Filter_Config(void) {
	CAN_FilterTypeDef CAN_FilterTypeDef;

	/*CAN็ญ้ๅจๅๅงๅ*/
	CAN_FilterTypeDef.FilterBank = 0;						//็ญ้ๅจ็ป0
	CAN_FilterTypeDef.FilterMode = CAN_FILTERMODE_IDLIST;	//ๅทฅไฝๅจๅ่กจๆจกๅผ
	CAN_FilterTypeDef.FilterScale = CAN_FILTERSCALE_32BIT;	//็ญ้ๅจไฝๅฎฝไธบๅไธช32ไฝใ
	/* ไฝฟ่ฝ็ญ้ๅจ๏ผๆ็งๆๅฟ็ๅๅฎน่ฟ่กๆฏๅฏน็ญ้๏ผๆฉๅฑIDไธๆฏๅฆไธ็ๅฐฑๆๅผๆ๏ผๆฏ็่ฏ๏ผไผๅญๅฅFIFO0ใ */

	CAN_FilterTypeDef.FilterIdHigh = ((((uint32_t) 0x2233 << 3) | CAN_ID_EXT
			| CAN_RTR_DATA) & 0xFFFF0000) >> 16;		//่ฆ็ญ้็ID้ซไฝ
	CAN_FilterTypeDef.FilterIdLow = (((uint32_t) 0x2233 << 3) | CAN_ID_EXT
			| CAN_RTR_DATA) & 0xFFFF; //่ฆ็ญ้็IDไฝไฝ
	CAN_FilterTypeDef.FilterMaskIdHigh = 0;		//็ฌฌไบไธชID็้ซไฝ
	CAN_FilterTypeDef.FilterMaskIdLow = 0;			//็ฌฌไบไธชID็ไฝไฝ
	CAN_FilterTypeDef.FilterFIFOAssignment = CAN_FILTER_FIFO0;	//็ญ้ๅจ่ขซๅณ่ๅฐFIFO0
	CAN_FilterTypeDef.FilterActivation = ENABLE;			//ไฝฟ่ฝ็ญ้ๅจ
	HAL_CAN_ConfigFilter(&hcan1, &CAN_FilterTypeDef);
}
```

### ุงูุงุฎุชุจุงุฑ



ูุชุญ ูุฏูุฑ ุงูุฃุฌูุฒุฉ ููุชุญูู ููุง ุฅุฐุง ูุงู ุงูุฌูุงุฒ ูุฏ ุธูุฑ ุฃู ูุง. ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฌูุงุฒ ุฃู ุฅุฐุง ูุงู ููุงู ุนูุงูุฉ ุชุนุฌุจ ุตูุฑุงุกุ ูุฑุฌู ุชูุฒูู ุจุฑูุงูุฌ ุงูุชุดุบูู [STM32 Virtual COM Port Driver](https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-utilities/stsw-stm32102.html) ูู ูููุน ST ุงูุฑุณูู.

ุฅุฐุง ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฌูุงุฒ ุจุดูู ุตุญูุญ ุจุนุฏ ุชุซุจูุช ุจุฑูุงูุฌ ุงูุชุดุบููุ ููููู ูุญุงููุฉ ุถุจุท "Minimum Heap Size" ุฅูู "0x600" ุฃู ุฃุนูู ูู CubeMX - Project Manager - Project - Linker Settings.

ุจุนุฏ ูุชุญ ุฃุฏุงุฉ ุงููููุฐ ุงูุชุณูุณูู (ุฃู ูุนุฏู ุจุชุงุช)ุ ููููู ุฅุฑุณุงู ุฃู ุญุฑู ูุณุชุนูุฏ ููุณ ุงูุญุฑู.

ุงููุฑุงุฌุน ูุงูุดูุฑ:

- [STM32CubeMX ูููุชุจุฉ HAL - ุงุฎุชุจุงุฑ ุฏูุฑุฉ CAN ุงูุจุณูุทุฉ](https://blog.csdn.net/weixin_45209978/article/details/119850600)

> ุชูุช ุชุฑุฌูุฉ ูุฐู ุงููุดุงุฑูุฉ ุจุงุณุชุฎุฏุงู ChatGPTุ ูุฑุฌู [**ุชุฒููุฏูุง ุจุชุนูููุงุชูู**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) ุฅุฐุง ูุงูุช ููุงู ุฃู ุญุฐู ุฃู ุฅููุงู.